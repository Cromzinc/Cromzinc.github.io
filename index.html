<!DOCTYPE html>
<html lang='en' class=''>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <link rel='stylesheet' href='./stylesheet.css'>
</head>

<body>
    <script>
        async function grubSearch() {
            let searchValue = document.getElementById('optional-input').value;
            removeRows();
            const position = await this.requestLocation();
            let lat = position.coords.latitude;
            let long = position.coords.longitude;
            let geoLoc = "Point(" + position.coords.longitude + "+" + position.coords.latitude + ")";
            console.log(geoLoc);

            let url = 'https://us-central1-optical-psyche-137823.cloudfunctions.net/function-1?search=' + searchValue + '&geo=' + geoLoc;

            fetch(url).then(function (response) {
                return response.json();
            }).then(function (j) {
                console.log(j);
                addRow(j);
            })
        }

        function requestLocation() {
            var options = {
                enableHighAccuracy: false,
                timeout: 5000,
                maximumAge: 0
            };
            return new Promise(function (resolve, reject, options) {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
        }

        function removeRows() {
            while (grid_parent.firstChild) {
                grid_parent.removeChild(grid_parent.firstChild);
            }
        }

        function addRow(name) {
            let noResults = document.getElementById("noResults");
            noResults ? container.removeChild(noResults) : null;
            if (name.length > 0) {
                name.forEach(item => {
                    var div = document.createElement('div');
                    div.className = 'row';
                    div.innerHTML = item.name;

                    document.getElementById('grid_parent').appendChild(div).setAttribute('onclick', `getRestaurentMenu(${item.restaurant_id})`);
                });
                document.getElementById('grid_parent').style.display = "block"
            } else {
                if (!container.noResults) {
                    var div = document.createElement('h1');
                    div.innerText = "No results found.";
                    document.getElementById('container').appendChild(div).setAttribute('id', 'noResults');
                }
            }

        }

        function getRestaurentMenu(id) {
            let url = 'https://us-central1-optical-psyche-137823.cloudfunctions.net/function-1?rest_id=' + id;
            fetch(url).then(function (response) {
                return response.json();
            }).then(function (j) {
                postMenu(j);
                console.log(j);
            })
        }

        function postMenu(restaurant) {
            let restName = restaurant.restaurant.name;
            let restCity = restaurant.restaurant.address.locality;
            let restState = restaurant.restaurant.address.region;
            let restStreet = restaurant.restaurant.address.street_address;
            let date = new Date().toISOString();


            var makeRequest, promises = [];

            makeRequest = function (data) {
                const url = 'https://efeed.azurewebsites.net/api/restaurant/';
                let formData = new FormData();
                formData.append("restaurants", JSON.stringify(data));
                promises.push(
                    fetch(url, {
                        method: 'PUT',
                        body: formData, // data can be `string` or {object}!
                        headers: {
                            'Access-Control-Allow-Origin': '*',
                            'Accept': 'application/json, text/plain, */*',
                            'Authorization': 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik1qazRSVVZEUmtaR01EVkdPRGsxTVVZMFJURTFSakJHTWpJM09FSTVOemt6TURNMU1qSXdRZyJ9.eyJpc3MiOiJodHRwczovL2ZlZWRtZS5hdXRoMC5jb20vIiwic3ViIjoiZ29vZ2xlLW9hdXRoMnwxMTI4MzIxNDA4MDk3MzgxNTEzMDkiLCJhdWQiOlsiaHR0cHM6Ly9lZmVlZC5henVyZXdlYnNpdGVzLm5ldCIsImh0dHBzOi8vZmVlZG1lLmF1dGgwLmNvbS91c2VyaW5mbyJdLCJpYXQiOjE1NTM0NDY5NTEsImV4cCI6MTU1MzUzMzM1MSwiYXpwIjoicjJGcWNONndPbmljSm00UlZHVFBKckptUEdoTjFTTlAiLCJzY29wZSI6Im9wZW5pZCBlbWFpbCBvZmZsaW5lX2FjY2VzcyJ9.Spg0o-6VqxuPCZPMjCiYYvE_bY-WGbegXg6-2ip6KIxdG7VM1vKjAg8tKvuwiyoN-UmIyBOd0QBjq6AcxjXD4cVWEWbCcW_7OG2W5RKEG_lEkdagfsdd-J0VPLp4qPlPynf7QqhnADXylpgjaCxCu7iKuvCkg_5aK_pd3e0S4LaeBvam61tOFMvc_UOQDMssCYwtK6-9D6SDJv3dJxyeeed0JcoMf_du236LRL5ygtHbnCG4tYSdTAGAWFpe4mYLmZ9OaNj6Qb1KH_-3Ri0KLFweZT9P_vLslv_BDbEWwm9BDOLxgURCSTGK3UCcMDfiM0SvsBhfX2aloVIGllop6g'
                        }
                    })
                );
            };

            restaurant.restaurant.menu_category_list.forEach(category_list => {
                category_list.menu_item_list.forEach(menuItem => {

                    let data = [
                        {
                            "Id": -1,
                            "Name": restName,
                            "Street": restStreet,
                            "City": restCity,
                            "State": restState,
                            "Items": [
                                {
                                    "Id": -1,
                                    "Name": menuItem.name,
                                    "Category": menuItem.menu_category_name,
                                    "CreatedOn": date
                                }
                            ]
                        }
                    ];
                    makeRequest(data);
                })
            })

        }


    </script>

    <div class="container" id="container">

        <h1>Import Restaurant Menu</h1>
        <p>
            <!-- <label for="optional-input">Search Restaurant Name</label> -->
            <input value="" name="restInput" type="text" id="optional-input" autocomplete="off"
                placeholder="Search Restaurant Name">
        </p>

        <div id="button">
            <button class="btn blue" onclick="grubSearch()">Search</button>
        </div>

        <div class="grid_parent" id="grid_parent"></div>

    </div>

</body>

</html>